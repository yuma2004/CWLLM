# 04 企業マスタ / 担当者（Company / Contact）

対応要件：
- `FR-CMP-01..03（Must）` 企業の登録/編集/検索、区分、タグ
- `FR-CTC-01..02（Must）` 先方担当者、自社担当者（オーナー）紐づけ
- 画面：`SCR-02 企業一覧` / `SCR-03 企業詳細（企業ページ）`

利用技術（現状）：
- Backend：Fastify + Prisma
- Frontend：React + Vite + Tailwind

---

## 完了条件（DoD）

- AI：企業CRUD + 担当者CRUDがAPIとして完成している（RBAC込み）
- AI：企業一覧が検索/フィルタでき、企業詳細で担当者を参照/追加できる
- AI：Companyの重複抑制（`normalizedName`）が効く（409等で拒否）
- AI：`backend`/`frontend` の `lint`/`test`/`build` が成功し、`git push` 済み

---

## API一覧（案 / AIが確定）

※ベースパスはプロジェクトで統一（推奨：`/api`）。ロールは「読むだけ=全員」「書く=admin/sales/ops」。

- `GET /companies`（検索/フィルタ/ページング）
- `POST /companies`（作成）
- `GET /companies/:id`（詳細）
- `PATCH /companies/:id`（更新）
- `DELETE /companies/:id`（MVPは論理削除でも可）
- `GET /companies/:id/contacts`
- `POST /companies/:id/contacts`
- `PATCH /contacts/:id`
- `DELETE /contacts/:id`

---

## TODO（TDD）

### 1) Backend：入力/出力スキーマ（AI）

- [x] Company作成/更新のバリデーション（必須：name、任意：category/status/tags/profile/ownerId）
- [x] Contact作成/更新のバリデーション（必須：name、任意：role/email/phone/memo）
- [x] レスポンスの形を固定（UIが壊れない）
- [x] RBAC：読み取りは許可、作成/更新/削除は `requireWriteAccess()`

### 2) Backend：Company CRUD（AI）

- [x] `normalizedName` 生成（例：全角半角/空白/記号の簡易正規化）を共通関数にする
- [x] `POST /companies`：重複時は409、正常時は201
- [x] `GET /companies`：`q`（部分一致）、`category`、`status`、`tag`、`ownerId`、ページング
- [x] `PATCH /companies/:id`：更新（tagsは置換/追加削除のどちらにするか決めて統一）
- [x] owner（自社担当）紐づけ：`ownerId` を `User.id` にFK（既存スキーマの確認）

### 3) Backend：Contact CRUD（AI）

- [x] `POST /companies/:id/contacts`：企業配下で作成
- [x] `GET /companies/:id/contacts`：一覧
- [x] `PATCH /contacts/:id` / `DELETE /contacts/:id`

### 4) Backend tests（AI）

- [x] Company作成→一覧/詳細で参照できる
- [x] `q`/`category`/`tag`/`ownerId` のフィルタが効く
- [x] Contact作成→企業詳細で参照できる
- [x] readonly は作成/更新/削除できない（403）
- [x] `normalizedName` のユニーク制約で重複が弾かれる（409）

### 5) Frontend：企業一覧（AI）

- [x] 一覧テーブル（名称/区分/ステータス/タグ/オーナー）
- [x] フィルタUI（区分/タグ/ステータス/担当者）＋検索ボックス
- [x] ページング（MVPは簡易でOK）
- [x] ローディング/エラー状態の表示

### 6) Frontend：企業詳細（AI）

- [x] プロフィール表示/編集（最小）
- [x] タグ表示/編集（最小）
- [x] 先方担当者一覧＋追加フォーム
- [ ] 以降の機能（CW/要約/タスク/案件/卸）はこの画面に集約していく前提でレイアウトだけ先に確保

### 7) Frontend tests（AI）

- [x] 一覧が描画される（モックでOK）
- [x] フィルタ操作でAPI呼び出しが変わる
- [x] 担当者追加フォームのバリデーション

### 8) AI検証（AIが実行）

- [x] `cd infra; docker compose up -d`
- [ ] `cd backend; npm ci; npm run prisma:generate; npm run migrate:dev; npm run seed`
- [x] `cd backend; npm run test; npm run lint; npm run build`
- [x] `cd frontend; npm ci; npm run test; npm run lint; npm run build`
- [ ] スモーク：`GET /companies` が 200（ログイン要否に合わせてCookie/トークンを付与）

### 9) 人間作業（必須のみ）

- [ ] 企業区分（category）/企業ステータス（status）/初期タグ候補の「運用上の候補」を確認（後から変更可能）

### 10) Git（AI）

- [ ] `git add -A`
- [ ] `git commit -m "feat: companies and contacts"`
- [ ] `git push`
