# 10 監査ログ / 変更履歴（AuditLog）

対応要件：
- `FR-AUD-01（Must）` 企業/案件/卸/タスクの変更履歴（変更者・日時・変更内容）
- `FR-AUD-02（Should）` 重要操作（削除、権限変更、連携設定変更）の監査ログ
- `NFR-AUD-01（Must）` 変更履歴が追えること

前提：
- `AuditLog` モデルは `backend/prisma/schema.prisma` に存在する

---

## 完了条件（DoD）

- AI：Company/Project/Wholesale/Task の create/update/delete で AuditLog が残る
- AI：actor（誰がやったか）が記録される
- AI：対象別・期間別で履歴を取得できる
- AI：UIで企業詳細の変更履歴が最低限見える
- AI：自動テストが通り、`git push` 済み

---

## TODO（TDD）

### 1) 監査の記録方針を確定（AI）

- [x] 記録対象の最小集合を決める（MVP：Company/Task、拡張：Project/Wholesale/User/設定）
- [x] 差分の形式を決める
  - [x] MVP案：`changes` に `{ before, after }` をJSON文字列で保存
  - [ ] 将来案：JSON Patch（RFC6902）
- [ ] 重要操作のカテゴリを決める（例：`action=delete`、`entityType=User` のrole変更など）

### 2) Backend：AuditLog書き込み（AI）

- [x] 共通ヘルパーを作る（例：`audit.log({entityType, entityId, action, userId, changes})`）
- [x] 既存/今後の各ルートで、成功時に AuditLog を作成
- [x] `userId` は JWT の `userId` から取得（未ログイン操作はnull）
- [x] 失敗時は AuditLog を書かない（成功のみ）

### 3) Backend：参照API（AI）

- [x] `GET /audit-logs`（entityType/entityId/期間/ページング）
- [x] RBAC：閲覧は admin（最小） or read権限（どちらにするか決める）

### 4) Backend tests（AI）

- [x] Company更新で AuditLog が1件増える
- [x] userId が記録される
- [x] 参照APIで対象のログが返る

### 5) Frontend（AI）

- [x] 企業詳細に「変更履歴」タブ（Companyの更新ログを表示）
- [ ] 管理者向けに監査ログ一覧（重要操作）※MVPは後回し可

### 6) AI検証（AIが実行）

- [x] `cd backend; npm run test; npm run lint; npm run build`
- [x] `cd frontend; npm run test; npm run lint; npm run build`
- [ ] スモーク：企業プロフィール更新→変更履歴に反映

### 7) 人間作業（必須のみ）

- [ ] 重要操作として監査したい操作（削除/権限/連携設定）を最終決定（後から追加可能）

### 8) Git（AI）

- [x] `git add -A`
- [x] `git commit -m \"feat: audit logs\"`
- [ ] `git push`
