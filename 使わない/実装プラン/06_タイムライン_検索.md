# 06 タイムライン / 全文検索（Message）

対応要件：
- `FR-COM-01（Must）` 企業ページで、紐づくCWメッセージを時系列に閲覧
- `FR-COM-02（Must）` 全文検索（企業横断/企業内）
- `FR-COM-03（Should）` メッセージのラベル付け
- `FR-COM-04（Could）` ピン留め/要点メモ
- `NFR-UX-01/02` 導線・検索性

前提：
- 05 の取り込みで `Message` がDBに存在すること

---

## 完了条件（DoD）

- AI：企業詳細で `Message` が時系列（新しい→古い）にページング表示できる
- AI：企業内検索と横断検索ができる（最低：本文検索 + 期間フィルタ）
- AI：検索が遅くならない最低限のインデックス/実装方針がある
- AI：ラベル付け（Should）は最小実装で付与/解除できる
- AI：`backend`/`frontend` の自動テストが通り、`git push` 済み

---

## API一覧（案 / AIが確定）

- `GET /companies/:id/messages`（ページング、期間、ラベル）
- `GET /messages/search`（横断：`q`、期間、companyId任意）
- `POST /messages/:id/labels`（付与）
- `DELETE /messages/:id/labels/:label`（解除）

---

## TODO（TDD）

### 1) Backend：一覧API（AI）

- [x] `GET /companies/:id/messages`
  - [x] sort：sentAt desc
  - [x] pagination：cursor or offset（MVPはoffsetでも可）
  - [x] filter：期間（from/to）
  - [x] filter：ラベル
- [x] RBAC：閲覧はログイン必須（read権限）

### 2) Backend：検索API（AI）

実装方針（推奨）：
- MVPでも検索体験を落としにくいので、PostgreSQLの全文検索（tsvector）を検討
- まずは `ILIKE '%q%'` で開始し、件数増で `GIN + to_tsvector` に切替でも可

- [x] `GET /messages/search`（companyId指定で企業内、未指定で横断）
- [x] 期間フィルタ（from/to）
- [x] 返却：messageId/roomId/sentAt/sender/body（抜粋）/companyId

### 3) Backend：ラベル（Should / AI）

- [x] 仕様を決める（ラベルは自由入力か、マスタ制か）
  - [x] MVP案：自由入力（ただし文字数/文字種のバリデーションは入れる）
- [x] DB方針（どれかに決めて実装）
  - [x] A) Messageに `labels: String[]` を追加（簡易）
  - [ ] B) `MessageLabel` テーブルを追加（柔軟）
- [x] 付与/解除APIを実装

### 4) Backend tests（AI）

- [x] 企業別一覧が時系列で返る
- [x] ページングが壊れない（次ページで重複/欠落しない）
- [x] 検索で該当メッセージが返る（企業内/横断）
- [x] ラベルが付与/解除できる

### 5) Frontend：企業詳細タイムライン（AI）

- [x] タイムライン表示（無限スクロール or ページング）
- [x] 企業内検索（入力→API呼び出し→結果表示）
- [x] メッセージ詳細（本文/送信者/日時/ルーム）
- [x] ラベル付与UI（最小：input + add/remove）

### 6) Frontend：横断検索（AI）

- [x] 検索画面（or ヘッダー検索）
- [x] 期間フィルタ（最小：直近7日/30日プリセット）
- [x] 検索結果から企業詳細へ遷移できる

### 7) Frontend tests（AI）

- [x] 検索入力→結果描画（モックでOK）
- [x] ラベル付与UIの最小テスト

### 8) AI検証（AIが実行）

- [x] `cd backend; npm run test; npm run lint; npm run build`
- [x] `cd frontend; npm run test; npm run lint; npm run build`
- [ ] スモーク：企業詳細でタイムラインが表示される（E2E or 最小確認）

### 9) 人間作業（必須のみ）

- [ ] なし（検索/表示の正しさはテストで担保する）

### 10) Git（AI）

- [x] `git add -A`
- [x] `git commit -m "feat: chatwork sync errors and message search"`
- [ ] `git push`
