# 03 DB設計 / マイグレーション（Prisma + PostgreSQL）

対応要件：
- `8.1 主要エンティティ`（Company/Contact/Project/Wholesale/Message/Summary/Task/AuditLog）
- `8.2 データ品質・整合性要件`

前提（現状）：
- `backend/prisma/schema.prisma` は既に存在するため、このマイルストーンは **設計の確定 + 破綻しない運用（テストDB分離/制約/seed）** を主目的にします。

---

## 完了条件（DoD）

- AI：要件に対して不足/過剰なフィールドがない（少なくともMVPのMustを満たす）
- AI：ユニーク制約/外部キー制約が意図通りに効く（重複/欠損を防げる）
- AI：テストが **テスト用DB** で実行され、開発DBを汚さない
- AI：`prisma migrate` / `prisma generate` / `seed` が再現性を持って成功する
- AI：`backend` の `lint`/`test` が成功し、`git push` 済み

---

## TODO（TDD）

### 1) スキーマ確定（AI）

- [ ] `Docs/要件定義書.md` と `backend/prisma/schema.prisma` を突合し、MVPのMustに必要な項目を確定
- [ ] 命名を揃える（例：`companyId`/`ownerId`/`roomId`/`messageId` などの一貫性）
- [ ] 重要フィールドの「自由記述だけ」を避ける（例：単価/マージンは数値カラムも持つ）
- [ ] ユニーク/外部キー制約を点検
  - [x] Company：`normalizedName` ユニーク（重複抑制）
  - [x] Message：`(roomId, messageId)` ユニーク（重複取り込み防止）
  - [x] Wholesale：必ず Project に紐づく（FK必須）
  - [ ] CompanyRoomLink：`(companyId, chatworkRoomId)` ユニーク（多重リンク防止）
- [ ] 将来の検索を見据えたインデックス方針を決める（例：Message検索用のGINは 06 で追加でもOK）
- [ ] 値がブレやすい項目（role/status/category）は、少なくともAPI層でバリデーションする方針を明記（enum化は後でも可）

### 2) マイグレーション運用（AI）

- [ ] `npm run prisma:generate` が常に通るようにする
- [x] `npm run migrate:dev` / `npm run migrate:deploy` の使い分けをREADMEに明記（既にあれば追記）
- [ ] スキーマ変更が入ったら「migration作成→レビュー→適用」の順で進める運用にする

### 3) seed（AI）

- [x] `backend/prisma/seed.ts` の初期ユーザーを **環境変数で上書き可能** にする（本番で固定パスワードを避ける）
  - [x] 例：`ADMIN_EMAIL` / `ADMIN_PASSWORD` / `ADMIN_ROLE`
- [x] 開発用ユーザー（sales/ops/readonly）は `NODE_ENV !== production` のときだけ作成（現状方針を維持）
- [x] seedを複数回実行しても壊れない（冪等）

### 4) テストDB分離（AI / 重要）

テストが開発DBを触る事故を防ぐため、**必ずテスト用DBを分離**します。

- [x] `DATABASE_URL_TEST` を追加（`.env.example` にも追加）
- [x] テスト実行時だけ `DATABASE_URL` を `DATABASE_URL_TEST` に差し替える仕組みを用意（例：Vitestのsetupで設定）
- [x] テスト開始前に「migrate + seed（またはtruncate）」できる仕組みを用意
  - [x] シンプル案：`cwllm_db_test` を作り、`prisma migrate reset --force` をテスト前に実行
- [x] テストで作ったデータは各テストでクリーンアップするか、テストDBを毎回リセットする

### 5) Backend tests（AI）

- [x] Company重複（`normalizedName`）が409等で拒否される
- [x] Message重複（`(roomId,messageId)`）が重複登録されない
- [x] WholesaleがProjectなしで作れない
- [x] seed後に admin/sales/ops/readonly が想定通り存在する

### 6) AI検証（AIが実行）

- [x] `cd infra; docker compose up -d`
- [ ] `cd backend; npm ci; npm run prisma:generate`
- [x] `cd backend; npm run migrate:dev; npm run seed`
- [x] `cd backend; npm run test; npm run lint`

### 7) 人間作業（必須のみ）

- [ ] 本番で使うDB（PostgreSQL）の提供方法だけ決める（マネージド or 自前）。値は後から差し替え可能

### 8) Git（AI）

- [ ] `git add -A`
- [ ] `git commit -m "chore: db schema and test-db isolation"`
- [ ] `git push`
