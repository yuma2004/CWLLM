# 08 企業別AI要約（人が最終確認できる導線つき）

対応要件：
- `FR-AI-01..03（Must）` 企業単位・期間指定の要約、要約内容、履歴保存
- `FR-AI-04（Should）` 要約からタスク候補抽出→ワンクリックでタスク化
- `FR-AI-05（Should）` 引用元（根拠メッセージ）へ遷移
- 注記：自動要約＝自動確定ではない（人が最終確認できる導線）
- 画面：`SCR-03 企業詳細（企業ページ）`

---

## 実装方針（MVP）

- 要約は「生成（draft）→確認/編集→保存」の2段階
- 保存データ：
  - `Summary.content`（本文）
  - `Summary.type`（manual/auto）
  - `Summary.periodStart/periodEnd`
  - `Summary.sourceLinks`（根拠：messageId/URL等の配列）
- LLMは差し替え可能にする（OpenAI/Azure等をインターフェースで隠蔽）
- テストはLLMをモックし、**APIキーなしでも通る**

---

## 完了条件（DoD）

- AI：指定期間のメッセージから要約を生成できる（draft）
- AI：要約を保存でき、履歴として一覧取得できる
- AI：引用元（sourceLinks）から該当メッセージへ辿れる
- AI：要約→タスク候補→Task作成ができる（最低1件）
- 人間（必須）：LLMキーを投入し、「業務で使える粒度か」を最終確認
- AI：自動テストが通り、`git push` 済み

---

## API一覧（案 / AIが確定）

- `POST /companies/:id/summaries/draft`（期間指定→draft生成）
- `POST /companies/:id/summaries`（保存：manual/auto、本文、sourceLinks）
- `GET /companies/:id/summaries`（履歴）
- `POST /summaries/:id/tasks/candidates`（タスク候補抽出）
- `POST /tasks`（07で実装済み想定。候補から作成）

---

## TODO（TDD）

### 1) Backend：要約対象の抽出（AI）

- [ ] 対象メッセージを取得（companyId + 期間）
- [ ] サイズ制御（長文対策）
  - [ ] 直近N件/直近N文字に切る
  - [ ] 重要そうなメッセージ（To/返信/特定ラベル）を優先する（拡張）
- [ ] 取り込み未完（companyId=null）を除外する

### 2) Backend：LLMインターフェース（AI）

- [ ] `LLMClient` インターフェースを定義（`summarize(messages)->draft`）
- [ ] 実装：OpenAI（or Azure）を1つ用意
- [ ] タイムアウト/リトライ/エラーメッセージ整形
- [ ] 機微情報（Should）：マスキング余地を残す（簡易でも可）

### 3) Backend：プロンプト/出力形式（AI）

- [ ] 出力の必須項目を固定（要件：重要トピック/未解決/次アクション）
- [ ] JSONで返すか、Markdownで返すか決める
  - [ ] 推奨：内部はJSON（安定）、UI表示はMarkdown整形
- [ ] sourceLinks（引用元）を「messageId配列」として返せるようにする（MVPは粗くてもOK）

### 4) Backend：API実装（AI）

- [ ] `POST /companies/:id/summaries/draft`
- [ ] `POST /companies/:id/summaries`（保存、manual/auto）
- [ ] `GET /companies/:id/summaries`（履歴：新しい順）
- [ ] RBAC：閲覧はread、保存はwrite

### 5) Backend：タスク候補抽出（Should / AI）

- [ ] draftから「次アクション」を抽出し候補化（まずはルールベースでOK）
- [ ] 候補の項目：title / dueDate（推定できれば）/ assignee（推定できれば）
- [ ] 候補→`POST /tasks` に変換できる

### 6) Backend tests（AI）

- [ ] LLMをモックして要約生成ができる
- [ ] 期間フィルタで対象メッセージが変わる
- [ ] 要約履歴が保存され、一覧で取得できる
- [ ] タスク候補→Task作成ができる（モックでOK）

### 7) Frontend（AI）

企業詳細（要約ブロック）：
- [ ] 期間選択（7日/30日/カスタム）
- [ ] 生成→プレビュー（draft）→編集→保存
- [ ] 要約履歴（最新＋過去）
- [ ] 引用元リンク（タイムラインの該当メッセージへジャンプ）
- [ ] タスク候補表示→「タスク化」ボタン

### 8) Frontend tests（AI）

- [ ] draft表示/保存の最小テスト（モック）
- [ ] 引用元リンクの生成ロジックのテスト（最小）

### 9) AI検証（AIが実行）

- [ ] `cd backend; npm run test; npm run lint; npm run build`
- [ ] `cd frontend; npm run test; npm run lint; npm run build`
- [ ] LLMモックで要約生成APIが通る
- [ ] （APIキーが投入されている場合）実データで要約を1回生成し、保存まで通る

### 10) 人間作業（必須のみ / 外部連携）

- [ ] LLMのAPIキーを投入（`.env`：例 `OPENAI_API_KEY`）
- [ ] 生成結果をレビューし、必要なら「どこが足りないか/何を優先すべきか」をAIへフィードバックする（プロンプト改善）

### 11) Git（AI）

- [ ] `git add -A`
- [ ] `git commit -m \"feat: ai summaries with human review\"`
- [ ] `git push`
