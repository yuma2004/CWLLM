# 12 デプロイ / 運用（最低限）

対応要件（主に非機能）：
- `NFR-SEC-03（Should）` アクセスログ（誰がいつ何を見た/変更した）
- `NFR-DATA-01（Should）` バックアップ/復旧
- `NFR-PERF-01（Should）` 表示性能（例：3秒以内）

---

## 完了条件（DoD）

- AI：本番相当の起動手順が `README` で再現できる（Docker推奨）
- AI：CIで `backend`/`frontend` の `lint`/`test`/`build` が毎回走る
- AI：最低限のログ（request_id/user_id/error）が出る
- AI：DBバックアップ/復旧の手順（or スクリプト）がある
- 人間（必須）：デプロイ先（クラウド/サーバ）とSecret投入方法を決め、実際に投入する

---

## TODO

### 1) 秘密情報/環境変数（AI）

- [ ] `.env.example` を整理（必須/任意/本番必須を明記）
  - [ ] DB：`DATABASE_URL`
  - [ ] Auth：`JWT_SECRET`
  - [ ] Chatwork：`CHATWORK_API_TOKEN`（使う場合）
  - [ ] LLM：`OPENAI_API_KEY` 等（使う場合）
- [ ] `.env` はリポジトリに入れない（既に `.gitignore` にあるか確認）

### 2) ログ（AI）

- [ ] `request_id` を付与（ミドルウェア）
- [ ] 認証済みなら `userId` / `role` をログに出す
- [ ] エラーを構造化（statusCode、route、原因）
- [ ] （Should）アクセスログ：参照/更新のイベントを `AuditLog` と役割分担（監査=DB、アクセス=ログ）

### 3) Docker化（AI）

- [ ] `backend/Dockerfile`（build→runtime）
- [ ] `frontend/Dockerfile`（build→static serve もしくは nginx）
- [ ] `docker-compose.prod.yml`（app + db、もしくはdbは外部）
- [ ] healthcheck を追加（backend `/healthz`）

### 4) CI（AI）

- [ ] GitHub Actions（or同等）を追加
  - [ ] backend：`npm ci`→`npm run prisma:generate`→`npm run test`→`npm run lint`→`npm run build`
  - [ ] frontend：`npm ci`→`npm run test`→`npm run lint`→`npm run build`
  - [ ] DBが必要なテストはサービスコンテナ（Postgres）で起動して `DATABASE_URL_TEST` を注入

### 5) DBバックアップ/復旧（AI）

- [ ] 手順を `README` に記載（`pg_dump` / `psql`）
- [ ] （可能なら）`infra/scripts/backup.ps1` 等のスクリプト化
- [ ] バックアップの保管場所/保持期間は人間が決める（運用）

### 6) 性能（AI）

- [ ] 企業詳細（重い画面）でページング/遅延ロードを徹底
- [ ] 検索はDBインデックスを前提にする（06で方針確定）

### 7) AI検証（AIが実行）

- [ ] CIがグリーンになるまで修正
- [ ] `docker compose -f docker-compose.prod.yml up` で起動し、`/healthz` が200
- [ ] migrate/seed が本番相当で通る

### 8) 人間作業（必須のみ）

- [ ] デプロイ先を決める（例：Render/Fly.io/ECS/VM等）
- [ ] Secretの投入（DB URL / JWT_SECRET / Chatwork token / LLM key）
- [ ] ドメイン/HTTPS（必要なら）

### 9) Git（AI）

- [ ] `git add -A`
- [ ] `git commit -m \"chore: deployment and ops\"`
- [ ] `git push`

