Chatwork要約ツール
MVP要件定義・基本設計

---

## 1. 概要

### 1.1 目的

* Chatworkのやり取りを自動で要約し、**顧客ごとに「最近何を話しているか」だけを一目で把握できる状態**にする。
* タスク管理機能はいったんやらず、「要約に特化した最小機能」をMVPとして実装する。

### 1.2 ゴール（MVP）

* 顧客名を選ぶと、その顧客とのChatworkの直近のやり取りが、

  * 日本語の要約（数行〜数十行）
  * 必要に応じて、最近の生メッセージ一覧
    としてWeb画面に表示されること。

---

## 2. スコープ

### 2.1 MVPに含める機能

* 顧客一覧・顧客検索
* 顧客単位の要約表示（直近の会話要約）
* Chatworkメッセージの取得・保存（対象ルーム限定）
* LLMによる要約生成（タスク抽出はしない）
* 顧客とChatworkルームの紐づけ（簡易UIでもOK）
* ログイン（社内メンバーのみ利用できる最低限の認証）

### 2.2 MVPで含めないもの

* タスク管理（抽出・一覧・ステータス変更など）
* 通知・リマインド機能
* 詳細な権限管理（部署ごとの閲覧制御など）
* 複数チャットツール対応（当面はChatworkのみ）
* スマホ専用UI最適化（PC利用前提の簡易レスポンシブ程度）

---

## 3. 機能要件

### 3.1 ログイン（F-01）

* 社内メンバーのみが利用できるよう、簡易なログイン機能を持つ。
* 想定仕様

  * メールアドレス（または社内ID）＋パスワード
  * 認証成功でセッションを発行し、顧客一覧画面へ遷移
* 高度な権限分けはMVPでは不要（全ユーザーが同じ範囲を見られる前提）。

---

### 3.2 顧客一覧・検索（F-02）

**目的**
状況を確認したい顧客を素早く選べるようにする。

**表示内容**

* 顧客名
* 最終やり取り日時（対象ルームの最新メッセージ日時）
* 要約最終更新日時（最新要約がいつ生成されたか）

**機能仕様**

* 顧客名による部分一致検索
* ソート

  * デフォルト：最終やり取り日時の新しい順
* 顧客行をクリックすると、顧客要約画面へ遷移。

---

### 3.3 顧客要約画面（F-03）

**目的**
顧客ごとに「最近どんな話をしているか」を1画面で把握する。

**表示構成**

1. 顧客基本情報

   * 顧客名
   * 関連Chatworkルーム一覧

     * ルーム名
     * 「Chatworkで開く」リンク（別タブでChatworkを開く）

2. 要約エリア（メイン）

   * 直近の会話要約テキスト
   * 要約対象期間の表記

     * 例：「直近7日分のやり取りを要約」「直近100件を要約」など
   * 要約生成日時

3. オプション：最近の生ログ表示（簡易）

   * 直近◯件（例：50件）のメッセージを、時系列で一覧表示する簡易ログ
   * 表示項目

     * 送信日時
     * 送信者
     * メッセージ本文

**操作**

* 対象期間切り替え（MVPでは固定でもよい）

  * まずは「直近7日分固定」または「直近100件固定」でスタート。
* 「再要約」ボタン（任意）

  * 即時でLLMに投げ直して要約を更新する操作を持たせるかどうかは運用とコスト次第。

---

### 3.4 Chatworkメッセージ同期（F-04）

**目的**
要約に必要なメッセージを定期的に取得・保存する。

**仕様（MVP）**

* 対象となるChatworkルーム

  * 顧客ごとに、あらかじめ「このルームを要約対象にする」と紐づけておく。
  * MVPでは、1顧客あたり1〜数ルーム程度に絞る想定。

* 同期方式

  * サーバー側で定期バッチを実行し、新着メッセージを取得。
  * インターバル目安：5〜15分間隔（運用と負荷を見て調整）

* 同期単位

  * ルームごとに前回取得した最新メッセージID（または日時）を持ち、それ以降のみ取得。

* 初回同期

  * 初回は「直近◯日分」または「直近◯件」だけ取得し、それより過去は切り捨ててもよい（MVP）。

---

### 3.5 要約生成（LLM）（F-05）

**目的**
顧客単位で、直近の会話の流れを短時間で把握できるようにする。

**対象データ**

* 対象期間

  * 直近7日間、もしくは直近◯件（例：100〜200件）を上限とする。
* 対象範囲

  * 顧客に紐づくすべてのChatworkルームのメッセージをまとめる。

**実行タイミング**

* メッセージ同期後のバッチで、顧客ごとに以下を実施

  * 前回要約生成以降に新着メッセージがある顧客だけを対象にする。
* 負荷やコストを見ながら、実行間隔を調整（例：15〜60分に1回など）。

**LLM入出力イメージ**

* 入力

  * 対象期間内のメッセージ一覧（送信者・日時・本文）
  * 併せて「要約の指示」（どのくらいの長さ・どんな観点でまとめるか）

* 出力（例）

  * 箇条書きまたは短い段落での要約

    * 最近話しているテーマ
    * こちらからの提案や説明の要点
    * 相手からの反応・検討状況
  * JSON形式にするか、テキストのみとするかは開発側で決定。

**画面への反映**

* 最新の要約を`Summaries`テーブルに保存。
* 顧客要約画面では、その顧客＋期間種別の最新要約を1件だけ表示。

---

### 3.6 顧客・ルーム紐づけ管理（F-06）

**目的**
どのChatworkルームがどの顧客に対応するかをシンプルに管理する。

**仕様**

* 管理者画面（簡易）

  * 顧客一覧から顧客を選択。
  * 利用可能なChatworkルーム一覧を表示。
  * チェックボックスで「この顧客に紐づけ」をON/OFFする。
* MVPでは

  * 1ルーム＝1顧客（多対多は対応しない前提でもよい）。
  * まずは手動紐づけで運用し、後から自動推定ロジックを追加してもよい。

---

## 4. 画面設計（論理レベル）

### 4.1 画面一覧

1. ログイン画面
2. 顧客一覧画面
3. 顧客要約画面
4. 顧客・ルーム紐づけ管理画面（管理者用）

### 4.2 顧客一覧画面

* 要素

  * 検索ボックス（顧客名）
  * 顧客一覧テーブル

    * 顧客名
    * 最終やり取り日時
    * 要約最終更新日時

* 操作

  * 顧客名クリック → 顧客要約画面へ遷移。

### 4.3 顧客要約画面

* 上部：顧客名・関連ルームリンク
* 中央：要約テキスト（スクロール可能）
* 下部：直近メッセージ一覧（必要に応じて）

---

## 5. データ設計（MVP必要分）

### 5.1 テーブル一覧

| テーブル名      | 内容          |
| ---------- | ----------- |
| users      | システムユーザー    |
| companies  | 顧客          |
| chat_rooms | Chatworkルーム |
| messages   | メッセージ       |
| summaries  | 顧客ごとの要約     |

### 5.2 テーブル項目（例）

**companies**

* id
* name
* created_at
* updated_at

**chat_rooms**

* id
* company_id
* chatwork_room_id
* name
* last_synced_at
* created_at
* updated_at

**messages**

* id
* chat_room_id
* chatwork_message_id
* sender_name
* sent_at
* body_text
* created_at
* updated_at

**summaries**

* id
* company_id
* period_type（例：’recent’ の1種類でも可）
* content（要約テキスト）
* generated_at
* created_at
* updated_at

**users**

* id
* name
* email
* password_hash
* role（admin / user）
* created_at
* updated_at

---

## 6. 処理フロー（MVP）

### 6.1 利用フロー

1. ユーザーがログイン。
2. 顧客一覧画面で顧客を検索・選択。
3. 顧客要約画面で

   * 直近要約を確認。
   * 必要であればChatworkリンクから元の会話を直接確認。

### 6.2 バックグラウンド処理

1. 一定間隔でChatwork同期ジョブ起動。
2. 各chat_roomsの`last_synced_at`以降のメッセージを取得し、messagesに保存。
3. 顧客ごとに「新しいメッセージがあるか」を判定。
4. 新規メッセージがある顧客について、要約生成ジョブを実行。
5. LLMから返ってきた要約をsummariesに保存（上書き or 新規＋最新フラグでも可）。

---

## 7. 非機能要件（MVPレベル）

* 利用環境

  * PCブラウザ（Chrome / Edge / Safari 等の最新）を想定。
* セキュリティ

  * 通信はHTTPS。
  * Chatwork APIトークン・LLM APIキーはサーバー側で安全に保管。
* 性能

  * 顧客要約画面の表示：数秒程度を目安。
  * 同期・要約処理は多少遅れてもよいが、「リアルタイムでなく数十分遅れ」程度を許容。

---
