【リファクタリング案】
1) API契約/入力検証の統一
- 手書きバリデーションをZodへ寄せ、Fastifyのschemaに統合（body/query/params/response）
- Swaggerを実用化し、将来的にフロント型生成へ接続

2) ルート肥大の解消（サービス層の強化）
- routes: HTTP入出力のみ
- services: 業務ロジック
- repositories(任意): Prismaクエリ集約（複雑クエリ隔離）

3) フロントのデータ取得方式の統一
- apiRequest直叩き と useFetch/useMutation の混在を解消
- キャッシュ/リトライ/エラー/ローディングを標準化（TanStack Query推奨 or 既存hooks拡張）

4) 型定義の重複排除
- ページ内interface禁止、src/typesへ集約（Project等の重複撤廃）

5) テスト整合性の回復
- 実装と乖離しているテストを修正
- CIで lint/test/build を必須化


【フロントエンド UI/UX 改善案】
1) 一覧検索UXの統一
- 自動検索（デバウンス）か、検索ボタン確定のどちらかに統一
- フィルタ状態をURLクエリと同期（Tasksの方式を横展開）

2) ID入力フィルタの撤廃（卸管理など）
- companyId/projectIdの手入力を廃止し、検索セレクト化（CompanySearchSelect相当を追加）

3) 表示の人間向け最適化
- companyId等のID表示を会社名/案件名表示に変更（API includeで補完）

4) 権限起因の失敗体験を削除
- admin専用機能（例：Chatworkルーム取得）を非adminで押せないUIに（非表示/disabled+理由）

5) ジョブ待ちUXの改善
- 進捗バー/成功失敗要約/キャンセル導線を共通コンポーネント化
- 完了時トースト通知を標準化


【バックエンド改善案】
1) P0バグ修正
- routes/tasks.ts の TARGET_TYPES 未定義参照を解消（normalizeTargetType一本化 or 定数定義）

2) バリデーション方針の統一
- enumクエリ（status/targetType等）は「指定されて無効なら400」を全ルート統一

3) OpenAPI/Swaggerの実用化
- 主要ルートからschema付与（params/query/body/response）
- 将来的にフロント型生成へ接続

4) ダッシュボード/一覧の返却情報充実
- タスクに target/assignee を含め、フロントのID表示を排除しやすくする

5) ジョブ実行基盤の事故防止
- productionでREDIS_URL必須（設定漏れで同期実行しない）
- worker分離を検討

6) 検索性能（中期）
- インデックス見直し → Postgres FTS（GIN+tsvector）へ段階移行


【Todo（ステップ別）】
Step 0: 健全性
- backend: lint/test/build が通る状態にする
- frontend: lint/test/build が通る状態にする
- 乖離テストがある場合、実装に合わせて更新（または仕様に合わせて実装修正）

Step 1: P0修正
- tasks.ts の TARGET_TYPES 未定義参照を修正
- dashboard関連の不整合テストを修正（期待値を現実に合わせる）
- 非adminで失敗するUI（Chatworkルーム取得等）を非表示/disabled化
- VITE_MOCK_AUTH を production で無効化するガード追加

Step 2: API契約/バリデーション統一（BE基盤）
- fastify + zod type provider導入
- companies/projects/tasks/messages/jobs の主要ルートにschema追加
- 「指定されて無効なenumは400」を全ルートへ適用
- /api/docs を主要CRUDが参照できる状態に

Step 3: FEデータ取得と型の標準化
- TanStack Query導入（or 既存hooksを全ページ標準に）
- ページ内interface廃止し src/types に統一
- 共通の Loading/Error/Toast パターンを整備して全ページに適用

Step 4: UX強化（優先順）
- 一覧検索UX統一（デバウンス or 検索確定）+ URLクエリ同期
- Wholesalesのフィルタを検索セレクト化（必要なら /projects/search 追加）
- ID表示→名称表示（API include調整 + UI差し替え）
- ジョブ進捗UIの共通化（進捗/結果要約/キャンセル）

Step 5: 運用・性能（中期）
- productionでREDIS_URL必須化 + redis追加 + worker分離検討
- メッセージ検索：インデックス最適化 → Full Text Search導入
- キャッシュ（options/labels等）導入（TTL）
- サマリー生成：直近優先・サンプリング・chunk方針見直し
