# 改善案と実行プラン

リポジトリ（frontend: React+TS+Vite / backend: Fastify+TS+Prisma(PostgreSQL)）を一通り確認し、実コード上の問題点も踏まえて「改善案一覧」と「TODO付き実行プラン」を整理しました。
確認対象（例）：`frontend/src/pages/Home.tsx`, `Tasks.tsx`, `App.tsx`, `CompanyDetail.tsx`, `MessageSearch.tsx`, `UnassignedMessages.tsx`, `Settings.tsx`, `CompanyAuditSection.tsx`、backend の `src/routes/tasks.ts`, `src/routes/chatwork.ts`, `src/services/llm.ts` 等。

---

## 1. まず直すべき「明確な不具合/ミスマッチ」（最優先）

### 1) フロントに卸（wholesale）ページが無く、リンクが壊れている

* `Home.tsx` の期日超過タスクリンクが `targetType === 'wholesale'` のとき `/wholesales/${id}` を参照
* `Tasks.tsx` でも `targetType === 'wholesale'` のリンク先が `/wholesales/:id`
* しかし `App.tsx` に `/wholesales` / `/wholesales/:id` のルートが存在しない
  → **クリックで404**になり、ユーザー体験上の致命傷です。

### 2) タスク「対象フィルタ」が効かない（FEは投げているがBEが見ていない）

* フロント `Tasks.tsx` は `/api/me/tasks?targetType=...` を付けている
* バック `GET /me/tasks` は `status, dueFrom, dueTo` しか見ておらず `targetType/targetId` を無視
  → **UI上フィルタがあるのに意味がない**状態。

### 3) 企業一覧取得（pageSize=1000）が実際には100件で頭打ち

* `MessageSearch.tsx` / `UnassignedMessages.tsx` / `ProjectDetail.tsx` 等で `pageSize=1000` で企業一覧を取ろうとしている
* バック `parsePagination()` が `pageSize` を最大100に固定
  → 企業が100件を超えると**選択肢に出ない**（割当・選択不能）。

### 4) CompanyDetail が admin 専用APIを admin 以外からも呼び出す

* `CompanyDetail.tsx` の `fetchAvailableRooms()` が `/api/chatwork/rooms`（backendで `requireAdmin()`）を呼ぶ
* 実行条件が `if (linkedRooms.length >= 0 && canWrite)` で **length>=0は常に真**
  → admin以外でも叩いてエラー（ただしUIには出ず console.error）＝“静かな不具合”。

### 5) 文字化け/エンコーディング混入が複数箇所

* `CompanyAuditSection.tsx` に置換文字（`U+FFFD`）が混入
* `MessageSearch.tsx` / `ChatworkSettings.tsx` 先頭にBOMらしき不可視文字（`U+FEFF`）が混入
* `backend/src/services/llm.ts` の truncate が `\x81c`（意図不明）を付与
  → 品質/保守性/事故率に直結。**最初に一掃**すべきです。

---

## 2. フロントエンド改善案（UX/デザイン/可読性/無駄の削減）

### A. ナビゲーション/情報設計（IA）改善

1. **「卸管理」メニューを追加**（一覧＋詳細）し、タスク・ダッシュボードからの導線を成立させる
2. `Layout.tsx` のナビ定義を外部化（`navConfig.ts`）して見通しを良くする
3. 画面上部に「グローバル検索」（会社/案件/メッセージ/タスク横断）を置く（検索起点のUXに寄せる）
4. 企業詳細や案件詳細に**パンくず**を追加（戻りやすさ）
5. サイドバー開閉状態を localStorage に保存（毎回開閉を強いない）

### B. 一貫したUIコンポーネント設計（デザインの統一＝無駄の削減）

現状：ページごとに `input` / `button` / `badge` / `error` がバラバラ（Tailwind直書きも多い）
→ “デザイン調整のたびに全ページ修正”という無駄が発生。

6. `Button / Input / Select / Textarea / Badge / Card / Tabs / Modal / Toast` を最小セットで共通化
7. `StatusBadge.tsx` に **project/wholesale の status**も含めた統一マッピングを実装（各所の `getStatusBadge()` を撤去）
8. `ErrorAlert` に `role="alert"`、閉じた後のフォーカス制御を追加（アクセシビリティ）
9. `confirm()` / `alert()` を廃止し、ConfirmDialog に統一（`ProjectDetail.tsx` 等）
10. ボタンの `disabled` 状態・ローディング状態を共通コンポーネントで表現（押せない理由を明示）

### C. ページ別UX改善

#### ダッシュボード（Home）

11. 期日超過だけでなく「本日」「3日以内」「7日以内」も分ける（トリアージUX）
12. タスク・要約・企業のカードに「最終更新」「担当者」「状態」など重要メタを増やす
13. “次に取るべき行動”のCTA（例：未割当メッセージ◯件→割当画面へ）を追加
14. 404導線（wholesale）を修正

#### タスク（Tasks）

15. 対象フィルタが機能するようにBE/FEどちらかを修正（最優先）
16. 表の列に「対象名（会社名/案件名/卸先）」を表示（IDだけは運用がつらい）
17. `status` 変更を **楽に**：ドロップダウン＋即時反映＋失敗時ロールバック（Optimistic UI）
18. `dueDate` の一括編集、`assignee` の一括変更（業務では必須になりがち）
19. Kanban表示（todo / in_progress / done）を追加（オプション）
20. フィルタ状態をURLに同期（共有可能、戻るボタンでも状態維持）
21. “自分のタスク”/“全タスク”切替を明確化（RBACも含めて）

#### 企業詳細（CompanyDetail）

22. タブ化（概要/メッセージ/タスク/要約/関連/監査/Chatwork）で視認性を上げる
23. タグ入力を「カンマ区切り」から **チップUI＋候補サジェスト**へ
24. `copyToClipboard` 実行時にトースト表示（コピー成功が分かる）
25. メッセージ一覧に「ラベルで絞り込み」「ラベル候補」「よく使うラベル」を追加
26. 検索語のハイライト（メッセージ本文）
27. 大量メッセージを想定し **仮想スクロール** または “もっと読む（ページング）”
28. `/api/chatwork/rooms` は admin のみ表示（現状の静かなエラーを解消）
29. 連携ルーム追加のUX：ルームID手入力ではなく **検索/選択**を基本にする
30. 担当者（contacts）の編集/削除/並び替え、重複検知を追加（運用で必ず必要）
31. 監査ログに userId ではなく email を表示（人が読める形）

#### メッセージ検索（MessageSearch）/未割当（UnassignedMessages）

32. 企業ドロップダウンを「100件制限がない方式」に変更（タイプアヘッド）
33. 検索結果のページング/総件数表示
34. “未割当 → まとめて割当” のバルク操作
35. ラベル付け/解除のバルク操作
36. 企業割当後の再検索の挙動改善（現在は再検索するが、UI上の進捗が薄い）
37. 「期間プリセット（7/30日）」と手入力期間のUXを整理（`custom`の扱いを明確化）

#### 案件（Projects / ProjectDetail）

38. Projects作成で companyId を手入力させない（会社検索/選択にする）
39. Projects一覧にもページング、並び替え（更新日/状態/担当）
40. ProjectDetail の卸先管理は有用なので、そこから **卸詳細ページ**へリンク、または統合的に扱う
41. 卸の状態・単価・マージン編集を “行内編集” に寄せる（モーダルでも良いが統一が大事）
42. 変更保存後にトースト＆差分表示（何が変わったか）

#### 設定/エクスポート/Chatwork設定

43. Settings/Exports は文言が英語混在なので日本語に統一（UXの信頼性）
44. Exports は「対象期間」「フィルタ」付きのエクスポートに進化（CSVが巨大化しがち）
45. Chatwork同期は同期中の状態（進捗・完了・失敗）をUIで分かりやすくする

### D. フロントの可読性/保守性改善（無駄の削減）

46. `fetch()` の直書きが散在（Home/Projects/ProjectDetail/CompanyDetail/Settings/Exports/MessageSearch/Unassignedなど）
    → `useFetch/useMutation` か、**TanStack Query（React Query）** などに寄せて「書き方を1種類」にする
47. レスポンスの `error` 取り回しを統一（例：`ApiError` 型、`readJson`共通）
48. エンティティ型がページ内に重複定義されている箇所を `src/types` に統合
49. `pageSize=1000` のような“魔法値”を撤去し、用途別に API/設計を整理
50. BOM/文字化けの混入を防ぐため `.editorconfig` を追加、CIで検知（後述）
51. ページ肥大化（Companies.tsx など大きい）を**機能単位コンポーネント**に分解
52. 画面ごとの “状態管理の粒度” を整理（フォーム状態/検索状態/表示状態が混ざりやすい）
53. ユーザー権限（readonly/admin等）によるUI分岐を共通関数化（`canWrite`, `isAdmin` を散らさない）

### E. パフォーマンス改善（実務的に効く）

54. メッセージ・企業・タスクの一覧は「検索条件が変わらない限り再取得しない」キャッシュ戦略を導入
55. 大量データのテーブルは仮想スクロール
56. 画面遷移単位で lazy import（コード分割）
57. `AbortController` でリクエスト中断（検索連打で古い結果が上書きされるのを防ぐ）

### F. アクセシビリティ/入力体験

58. フォーカスリング、キーボード操作（モーダルのフォーカストラップ等）
59. 日付のローカライズ（表示フォーマット統一）、相対時刻（“3日前”）オプション
60. エラー表示はフォーム直下に（どこが悪いか明確に）

---

## 3. バックエンド改善案（API/設計/可読性/性能/運用）

### A. APIの一貫性（フロントの無駄を消す）

1. エラー形式を統一：`{ error: { code, message, details? } }` のように固定
   　→ フロント側の例外処理が激減
2. ページングの戻り形式を全て統一（items + pagination）
3. `/me/tasks` を `/tasks` と同等のクエリを受けられるようにする（現状の不具合解消）
4. タスクに “対象名” を返す拡張（`target: { id, type, name }`）
   　→ フロントで targetId だけ見せる苦行を撤廃
5. “企業の選択肢” は **全件取得を前提にしない**：

   * `GET /companies/search?q=...&limit=...`（タイプアヘッド用）
   * もしくは `GET /companies?limit=...` を上限変更する特別エンドポイント
     など、プロダクト要件に合う形で設計し直す

### B. バリデーション/型安全の強化（保守性と事故率に直結）

6. Fastifyのschema（JSON Schema）か Zod を導入して **入力検証を宣言的に**（今は手書きが多い）
7. Role / status / targetType は Prisma側も **enum** 化してDBレベルで担保（今はString）
8. `companies/options` のような集計系は性能劣化しやすいので、キャッシュ戦略 or 別テーブル化

### C. DB/クエリ性能

9. `Task(dueDate,status)` あたりの複合index（期日超過系クエリが増える）
10. `Project(companyId)`、`Wholesale(companyId, projectId)` のindex追加検討
11. メッセージ本文検索は `contains` だと厳しくなるので、PostgreSQL全文検索（GIN index）導入検討
12. `companies/options` は全企業走査なので、distinct/unnest などで改善（規模が上がると効く）

### D. Chatwork同期の信頼性/運用性

13. 同期処理を “HTTPリクエストで完結” させない（長時間・失敗リトライ・並列制御が必要）
    → ジョブキュー（BullMQ等）＋進捗APIに移行
14. 同期の排他（同時実行を抑制）と、ジョブ履歴（成功/失敗/件数/所要時間）の保存
15. 429/5xxの再試行は既にあるが、**ルーム単位の部分失敗**の見せ方をAPIで整備

### E. LLM要約の品質/コスト/失敗耐性

16. `services/llm.ts` の `truncate` の不正文字 `\x81c` を修正（確実に直すべき）
17. 入力が大きくなるとトークン超過しやすいので、**分割要約（map-reduce）**や “直近n件/上限文字数” を戦略的に
18. 要約生成の非同期化（ジョブ化）＋キャンセル/再実行/再利用（キャッシュ）
19. 生成時に `model`, `promptVersion`, `sourceMessageCount`, `tokenUsage(取得できる範囲で)` を保存（監査と改善に必須）
20. 要約の日本語化（プロンプトが英語固定なので改善余地）

### F. 監査ログ（Audit）

21. `AuditLog.changes` が String なので Json 型にしてクエリ可能に（検索/差分表示が楽になる）
22. message割当・ラベル追加/削除・Chatworkルーム紐付けも監査対象に（運用で追跡が必要）

### G. セキュリティ/設定健全性

23. `JWT_SECRET` が未設定でも起動できる（デフォルト値）
    → productionでは**未設定なら起動失敗**にする
24. CORS `origin: true` は運用上リスクになり得る
    → allowlist化（環境変数で管理）
25. ログインのレートリミット（ブルートフォース対策）
26. パスワードポリシー（最小長など）
27. `trustProxy` 設定（Cookie secure とIPログの整合性）

### H. 開発体験/ドキュメント

28. OpenAPI（Swagger）を生成して、FEの型生成につなげる（契約駆動に寄せる）
29. envの必須チェック（Zodで `env.ts` 作成、起動時にvalidate）

---

## 4. TODO付き実行プラン（優先度順・依存関係つき）

下記は **「壊れている導線を直す → 仕様/契約を固める → UXを伸ばす → 運用耐性を上げる」** の順です。
優先度は P0（最優先）/P1（高）/P2（中）/P3（任意）で表記します。

---

### フェーズ0：動作修正・導線復旧（P0中心）

**狙い：ユーザーが詰まる箇所をゼロにする**

* [ ] **P0 / FE** `/wholesales` 一覧ページを新規作成

  * ルート追加：`App.tsx` に `/wholesales`
  * ナビ追加：`Layout.tsx`
  * API：`GET /api/wholesales` 使用
* [ ] **P0 / FE** `/wholesales/:id` 詳細ページを新規作成

  * `GET /api/wholesales/:id` + `GET /api/wholesales/:id/tasks` を表示
  * タスク・ダッシュボードからのリンクが成立すること
* [ ] **P0 / BE** `GET /me/tasks` に `targetType/targetId` フィルタを追加

  * `GET /tasks` と同等のクエリ解釈に寄せる（現状UIが無意味）
* [ ] **P0 / FE** `Tasks.tsx` のフィルタが実際に効くことを確認（E2E または最小限の自動テストを追加）
* [ ] **P0 / FE** `CompanyDetail.tsx` の `fetchAvailableRooms()` を **adminのみに制限**

  * `linkedRooms.length >= 0` を修正（常時trueのため）
  * admin以外は「追加できません（権限）」のUIを表示
* [ ] **P0 / FE+BE** 企業選択UIの改善（100件制限問題の解消）

  * 選択肢：

    * [ ] **P0 / BE** `GET /companies/search?q=&limit=` を追加（推奨）
    * [ ] **P1 / FE** `MessageSearch/Unassigned/ProjectDetail` の企業選択をタイプアヘッド化
* [ ] **P0 / FE** 文字化け/BOMを除去

  * `CompanyAuditSection.tsx` の置換文字（`U+FFFD`）を正規の区切り文字に修正
  * `MessageSearch.tsx` / `ChatworkSettings.tsx` 先頭BOMを除去
* [ ] **P0 / BE** `services/llm.ts` の `truncate()` の `\x81c` を `…` などに修正 + 単体テスト
* [ ] **P0 / FE** 英語混在（Settings/Exports/Audit Logsなど）を日本語に統一（最低限の文言）

**完了条件（フェーズ0）**

* 卸関連リンクが404にならない
* タスク対象フィルタが本当に効く
* 企業選択で「出てこない企業」が起きない
* admin以外でChatwork候補取得が走らない（静かな失敗がない）
* 文字化けが残っていない

---

### フェーズ1：フロントの実装方式を統一し、無駄を削る（P1中心）

**狙い：ページごとの“書き方の違い”をなくし、修正コストを下げる**

* [ ] **P1 / FE** APIクライアントを一本化（`src/lib/apiClient.ts`）

  * `credentials: 'include'`、エラーJSON解釈、Abort対応、型パラメータ対応
* [ ] **P1 / FE** `useFetch/useMutation` の適用範囲を拡大（または React Query 導入）

  * 対象：`Home`, `Projects`, `ProjectDetail`, `CompanyDetail`, `MessageSearch`, `UnassignedMessages`, `Settings`, `Exports`, `ChatworkSettings`, `CompanyAuditSection`, `CompanyRelationsSection`, `CompanySummarySection`
* [ ] **P1 / FE** 型定義の重複排除

  * ページ内 `interface` を `src/types` に寄せる
* [ ] **P1 / FE** ステータス表示の統一

  * `StatusBadge` に project/wholesale のマッピング追加
  * 各ページの `getStatusBadge()` を撤去
* [ ] **P1 / FE** UIコンポーネントの最小デザインシステム化

  * Button/Input/Select/Badge/Card/Modal/Toast/Skeleton を共通化
  * alert/confirm の撤去
* [ ] **P1 / FE** `.editorconfig` 追加 + Prettier/EslintでBOM/不可視文字混入を防止（CIでチェック）
* [ ] **P1 / FE** 権限判定を共通化（`usePermissions()` 等）

  * `canWrite`, `isAdmin` を散在させない

---

### フェーズ2：主要業務フローのUXを“使えるレベル”まで引き上げ（P1〜P2）

**狙い：日々の運用が楽になる改善を集中投入**

* [ ] **P1 / FE** タスク一覧に「対象名」を表示（会社名/案件名/卸先名）
* [ ] **P1 / BE** タスク取得APIに対象情報を付与する拡張

  * 例：`GET /tasks` で `target: { type, id, name }` を返す（N+1回避で実装）
* [ ] **P1 / FE** 未割当メッセージにページング＋一括割当（バルク）を追加
* [ ] **P1 / BE** メッセージラベルの候補取得API（集計）を追加

  * 例：`GET /messages/labels`（頻出順、上限付き）
* [ ] **P2 / FE** メッセージ検索：検索語ハイライト、ラベル絞り込み、URL同期
* [ ] **P2 / FE** 企業タグ入力をチップ化＋候補表示（`companies/options` or settingsから）
* [ ] **P2 / FE** Projects作成を companyId手入力から選択へ（タイプアヘッド）
* [ ] **P2 / FE** 卸一覧：project/company/status フィルタ＋CSVエクスポート導線
* [ ] **P2 / FE** 要約画面：設定の default period を使用（`/api/settings` と連動）、生成中UI、候補タスクの一括作成

---

### フェーズ3：バックエンドの契約・性能・運用耐性を強化（P1〜P2）

**狙い：規模が増えても壊れにくく、変更しやすいAPIにする**

* [ ] **P1 / BE** リクエストバリデーションをスキーマ化（Zod or JSON Schema）
* [ ] **P1 / BE** エラーレスポンス形式を統一（フロントの例外処理を固定）
* [ ] **P1 / BE** OpenAPI（Swagger）を生成し、FE型生成につなげる
* [ ] **P2 / DB** Prismaのenum化（Role/TaskStatus/ProjectStatus/WholesaleStatus/TargetType）
* [ ] **P2 / DB** index追加（Task dueDate/status、Project companyId、Wholesale companyId 等）
* [ ] **P2 / BE** `companies/options` の高速化（distinct/キャッシュ/設定テーブル化のいずれか）
* [ ] **P2 / DB** AuditLog.changes を Json 型へ変更、監査対象の拡大（message割当/ラベル/ルーム紐付け）

---

### フェーズ4：非同期ジョブ化（Chatwork同期・要約生成）（P2〜P3）

**狙い：長時間処理をHTTPから切り離し、失敗時に再実行できるようにする**

* [ ] **P2 / BE** Chatwork同期をジョブキュー化（BullMQ等）

  * 実行API：`POST /chatwork/sync`（ジョブ起動）
  * 参照API：`GET /jobs/:id`（進捗、結果、失敗理由）
* [ ] **P2 / FE** 同期の進捗表示・完了通知（ChatworkSettings）
* [ ] **P2 / BE** 要約生成もジョブ化（入力サイズ対策、再試行、キャンセル）
* [ ] **P3 / BE** 要約の分割戦略（map-reduce）、メタ情報保存（model/promptVersion等）

---

### フェーズ5：セキュリティ/運用（P1〜P3、環境に応じて）

**狙い：本番運用で事故が起きにくい状態にする**

* [ ] **P1 / BE** productionで `JWT_SECRET` 未設定なら起動失敗
* [ ] **P1 / BE** CORS allowlist化
* [ ] **P1 / BE** login レートリミット
* [ ] **P2 / BE** 構造化ログ＋リクエストID（トレーシングしやすく）
* [ ] **P2 / INFRA** DBバックアップ/リストア手順の標準化（スクリプト化）
* [ ] **P3 / FE** 監視/メトリクスの表示（同期失敗、LLM失敗率など）

---

## 補足：最短で効く“おすすめ着手順”（迷ったらこれ）

1. **卸ページ追加（404解消）**
2. **/me/tasks フィルタ対応**（UIが嘘をついている状態を解消）
3. **企業選択をタイプアヘッド化**（100件問題を根絶）
4. **admin専用API呼び出しの是正**（静かなエラーを消す）
5. **API呼び出し方式の統一（useFetch/useMutation or React Query）**（無駄を削る）

---
