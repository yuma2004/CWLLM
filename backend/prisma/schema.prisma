// Prisma schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      String   @default("readonly")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companies  Company[]
  projects   Project[]
  wholesales Wholesale[]
  tasks      Task[]

  @@map("users")
}

model Company {
  id             String   @id @default(cuid())
  name           String
  normalizedName String
  category       String?
  status         String   @default("active")
  tags           String[]
  profile        String?
  ownerId        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  owner     User?             @relation(fields: [ownerId], references: [id])
  contacts  Contact[]
  projects  Project[]
  wholesales Wholesale[]
  messages  Message[]
  summaries Summary[]
  roomLinks CompanyRoomLink[]

  @@unique([normalizedName])
  @@map("companies")
}

model Contact {
  id        String   @id @default(cuid())
  companyId String
  name      String
  role      String?
  email     String?
  phone     String?
  memo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("contacts")
}

model Project {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  conditions  String?
  unitPrice   Float?
  periodStart DateTime?
  periodEnd   DateTime?
  status      String   @default("active")
  ownerId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company    Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  owner      User?      @relation(fields: [ownerId], references: [id])
  wholesales Wholesale[]
  messages   Message[]

  @@map("projects")
}

model Wholesale {
  id         String   @id @default(cuid())
  projectId  String
  companyId  String
  conditions String?
  unitPrice  Float?
  margin     Float?
  status     String   @default("active")
  agreedDate DateTime?
  ownerId    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  project  Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  company  Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  owner    User?   @relation(fields: [ownerId], references: [id])
  messages Message[]

  @@map("wholesales")
}

model ChatworkRoom {
  id               String   @id @default(cuid())
  roomId           String   @unique
  name             String
  description      String?
  lastSyncAt       DateTime?
  lastMessageId    String?
  lastErrorAt      DateTime?
  lastErrorMessage String?
  lastErrorStatus  Int?
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  messages  Message[]
  roomLinks CompanyRoomLink[]

  @@map("chatwork_rooms")
}

model CompanyRoomLink {
  id            String   @id @default(cuid())
  companyId     String
  chatworkRoomId String
  createdAt     DateTime @default(now())

  company Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  room    ChatworkRoom @relation(fields: [chatworkRoomId], references: [id], onDelete: Cascade)

  @@unique([companyId, chatworkRoomId])
  @@map("company_room_links")
}

model Message {
  id            String   @id @default(cuid())
  chatworkRoomId String
  roomId        String
  messageId     String
  sender        String
  body          String
  sentAt        DateTime
  labels        String[] @default([])
  companyId     String?
  projectId     String?
  wholesaleId   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  chatworkRoom ChatworkRoom @relation(fields: [chatworkRoomId], references: [id], onDelete: Cascade)
  company      Company?     @relation(fields: [companyId], references: [id])
  project      Project?     @relation(fields: [projectId], references: [id])
  wholesale    Wholesale?   @relation(fields: [wholesaleId], references: [id])

  @@unique([roomId, messageId])
  @@index([companyId])
  @@index([companyId, sentAt])
  @@map("messages")
}

model Summary {
  id          String   @id @default(cuid())
  companyId   String
  periodStart DateTime
  periodEnd   DateTime
  content     String
  type        String   @default("manual")
  sourceLinks String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("summaries")
}

model Task {
  id          String   @id @default(cuid())
  targetType  String
  targetId    String
  assigneeId  String?
  title       String
  description String?
  dueDate     DateTime?
  status      String   @default("todo")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  assignee User? @relation(fields: [assigneeId], references: [id])

  @@index([targetType, targetId])
  @@index([assigneeId])
  @@map("tasks")
}

model AuditLog {
  id         String   @id @default(cuid())
  entityType String
  entityId   String
  action     String
  userId     String?
  changes    String
  createdAt  DateTime @default(now())

  @@map("audit_logs")
}

model AppSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("app_settings")
}
