// Prisma schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  employee
}

enum TaskStatus {
  todo
  in_progress
  done
  cancelled
}

enum ProjectStatus {
  active
  paused
  closed
}

enum WholesaleStatus {
  active
  paused
  closed
}

enum DealStatus {
  pre_contact
  contacting
  negotiating
  agreed
  preparing_publish
  publishing
  stopped
  dropped
}

enum TargetType {
  company
  project
  wholesale
  general
}

enum SummaryType {
  manual
}

enum JobStatus {
  queued
  processing
  completed
  failed
  canceled
}

enum JobType {
  chatwork_rooms_sync
  chatwork_messages_sync
}

enum FeedbackType {
  bug
  improvement
  other
}

enum NoteType {
  negotiation
  request
  report
  confirmation
  other
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  role      UserRole @default(employee)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects         Project[]
  wholesales       Wholesale[]
  tasks            Task[]
  jobs             Job[]
  feedbacks        Feedback[]
  dealNegotiations DealNegotiation[]
  notes            Note[]

  @@map("users")
}

model Company {
  id             String   @id @default(cuid())
  name           String
  normalizedName String
  category       String?
  status         String   @default("active")
  tags           String[]
  profile        String?
  ownerIds       String[] @default([])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  contacts   Contact[]
  projects   Project[]
  wholesales Wholesale[]
  messages   Message[]
  summaries  Summary[]
  roomLinks  CompanyRoomLink[]
  notes      Note[]

  @@unique([normalizedName])
  @@map("companies")
}

model Contact {
  id        String   @id @default(cuid())
  companyId String
  name      String
  role      String?
  email     String?
  phone     String?
  memo      String?
  sortOrder Int      @default(0)
  sortKey   String   @default("")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, sortKey])
  @@map("contacts")
}

model Project {
  id          String        @id @default(cuid())
  companyId   String
  name        String
  conditions  String?
  unitPrice   Float?
  periodStart DateTime?
  periodEnd   DateTime?
  status      ProjectStatus @default(active)
  ownerId     String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  company    Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  owner      User?       @relation(fields: [ownerId], references: [id])
  wholesales Wholesale[]
  messages   Message[]
  notes      Note[]

  @@index([companyId])
  @@map("projects")
}

model Wholesale {
  id                String          @id @default(cuid())
  projectId         String
  companyId         String
  conditions        String?
  unitPrice         Float?
  margin            Float?
  status            WholesaleStatus @default(active)
  agreedDate        DateTime?
  ownerId           String?
  dealStatus        DealStatus      @default(pre_contact)
  proposedUnitPrice Float?
  agreedUnitPrice   Float?
  nextActionAt      DateTime?
  specialConditions String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  project      Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  company      Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  owner        User?             @relation(fields: [ownerId], references: [id])
  messages     Message[]
  negotiations DealNegotiation[]
  notes        Note[]

  @@index([companyId, projectId])
  @@map("wholesales")
}

model DealNegotiation {
  id               String   @id @default(cuid())
  wholesaleId      String
  actorId          String?
  offeredUnitPrice Float?
  agreedUnitPrice  Float?
  note             String?
  actionAt         DateTime
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  wholesale Wholesale @relation(fields: [wholesaleId], references: [id], onDelete: Cascade)
  actor     User?     @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([wholesaleId, actionAt])
  @@index([actorId])
  @@map("deal_negotiations")
}

model ChatworkRoom {
  id               String    @id @default(cuid())
  roomId           String    @unique
  name             String
  description      String?
  lastSyncAt       DateTime?
  lastMessageId    String?
  lastErrorAt      DateTime?
  lastErrorMessage String?
  lastErrorStatus  Int?
  isActive         Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  messages  Message[]
  roomLinks CompanyRoomLink[]

  @@map("chatwork_rooms")
}

model CompanyRoomLink {
  id             String   @id @default(cuid())
  companyId      String
  chatworkRoomId String
  createdAt      DateTime @default(now())

  company Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  room    ChatworkRoom @relation(fields: [chatworkRoomId], references: [id], onDelete: Cascade)

  @@unique([companyId, chatworkRoomId])
  @@map("company_room_links")
}

model Message {
  id             String   @id @default(cuid())
  chatworkRoomId String
  roomId         String
  messageId      String
  sender         String
  body           String
  sentAt         DateTime
  labels         String[] @default([])
  companyId      String?
  projectId      String?
  wholesaleId    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  chatworkRoom ChatworkRoom @relation(fields: [chatworkRoomId], references: [id], onDelete: Cascade)
  company      Company?     @relation(fields: [companyId], references: [id])
  project      Project?     @relation(fields: [projectId], references: [id])
  wholesale    Wholesale?   @relation(fields: [wholesaleId], references: [id])

  @@unique([roomId, messageId])
  @@index([companyId])
  @@index([companyId, sentAt])
  @@index([labels], type: Gin, map: "messages_labels_idx")
  @@map("messages")
}

model Summary {
  id          String      @id @default(cuid())
  companyId   String
  periodStart DateTime
  periodEnd   DateTime
  content     String
  type        SummaryType @default(manual)
  sourceLinks String[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("summaries")
}

model Task {
  id          String     @id @default(cuid())
  targetType  TargetType
  targetId    String
  assigneeId  String?
  title       String
  description String?
  dueDate     DateTime?
  status      TaskStatus @default(todo)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  assignee User? @relation(fields: [assigneeId], references: [id])

  @@index([targetType, targetId])
  @@index([dueDate, status])
  @@index([assigneeId])
  @@map("tasks")
}

model Note {
  id          String   @id @default(cuid())
  type        NoteType @default(other)
  content     String
  companyId   String?
  projectId   String?
  wholesaleId String?
  authorId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company   Company?   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project   Project?   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  wholesale Wholesale? @relation(fields: [wholesaleId], references: [id], onDelete: Cascade)
  author    User?      @relation(fields: [authorId], references: [id], onDelete: SetNull)

  @@index([companyId, createdAt])
  @@index([projectId, createdAt])
  @@index([wholesaleId, createdAt])
  @@index([authorId, createdAt])
  @@map("notes")
}

model Feedback {
  id        String       @id @default(cuid())
  userId    String
  type      FeedbackType @default(improvement)
  title     String?
  message   String
  pageUrl   String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type, createdAt])
  @@map("feedbacks")
}

model Job {
  id         String    @id @default(cuid())
  type       JobType
  status     JobStatus @default(queued)
  payload    Json
  result     Json?
  error      Json?
  userId     String?
  startedAt  DateTime?
  finishedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user User? @relation(fields: [userId], references: [id])

  @@index([type, status])
  @@index([createdAt])
  @@map("jobs")
}
